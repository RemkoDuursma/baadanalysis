\documentclass{article}


\begin{document}

\title{Scaling of leaf and above-ground woody biomass}
\maketitle


<<load, echo=FALSE, message=FALSE>>=
setwd("..//")
dat <- readRDS("cache/allomdata_post.rds")

library(smatr)
#library(tables)
library(magicaxis)
library(scales)
#library(Hmisc)
#library(MIfuns)
source("R/remko_functions.R")
source("R/plotting.R")
@


<<prep, echo=FALSE>>=
# Stem-leaf scaling

# Select datasets that have stem, leaf biomass, and height
x <- suppressMessages(studyWithVars(dat, c("m.st","m.lf","h.t")))
x$dataset_species <- paste0(x$dataset,"_",x$species)

# clean
x <- subset(x, m.lf > 0 & m.st > 0 & !is.na(m.lf) & !is.na(m.st) & !is.na(h.t))

# Keep only dataset_species with at least 20 observations
tab <- table(x$dataset_species)
x <- x[x$dataset_species %in% names(tab)[tab>19],]
@

The selected data has \Sexpr{nrow(x)} rows, and \Sexpr{length(unique(x$dataset_species))} unique dataset-species combinations. 

<<echo=FALSE>>=
xtabs(~ pft + vegetation,data=x)
@


<<analysis, echo=FALSE>>=

# sma by dataset_species
sm_mlf <- sma(m.lf ~ h.t * dataset_species, log="xy", data=x)
sm_mst <- sma(m.st ~ h.t * dataset_species, log="xy", data=x)

# quadratic across all data


# sma coefficients
makedfr <- function(z){
  z$dataset_species <- rownames(z)
  as.data.frame(z)
}
p_mlf <- coef(sm_mlf)
names(p_mlf) <- c("b0_mlf","b1_mlf")
p_mst <- coef(sm_mst)
names(p_mst) <- c("b0_mst","b1_mst")
p <- merge(makedfr(p_mlf),makedfr(p_mst))

# Find ranges for h.t
r <- t(sapply(p$dataset_species, function(lev){
    range(x$h.t[x$dataset_species==lev], na.rm=TRUE)
}))
colnames(r) <- c("ht_min","ht_max")

# P is a dataframe with leaf, stem scaling, and ranges of h.t
P <- cbind(p,r)
rownames(P) <- NULL

# Add some metadata
dfr <- dat[,c("dataset","species","pft","vegetation","growingCondition")]
dfr$dataset_species <- with(dfr, paste0(dataset,"_",species))
dfr <- dfr[!duplicated(dfr$dataset_species),]
P <- merge(P, dfr)
P$pft <- as.factor(P$pft)
P$vegetation[is.na(P$vegetation)] <- "GH"
P$vegetation <- as.factor(P$vegetation)


# Plot : save predictions in a list
l <- lapply(1:nrow(P), function(i){
  h <- seq(P$ht_min[i], P$ht_max[i], length=101)
  a <- 10^(P$b0_mlf[i])
  b <- P$b1_mlf[i]
  c <- 10^(P$b0_mst[i])
  d <- P$b1_mst[i]
  wfrel <- a*h^b/(a*h^b + c*h^d)
  mst <- c*h^d
  mlf <- a*h^b
  return(data.frame(h=h,wfrel=wfrel,mlf=mlf,mst=mst))
})

@



\section{By plant functional type}

<<plotting, echo=FALSE>>=

# nonfield <- union(which(P$vegetation == "GH"), which(P$dataset == "Poorter1999"))
nonfield <- which(P$growingCondition %in% c("CG","GH"))
field <- setdiff(1:nrow(P), nonfield)

# Non-glasshouse
palette(alpha(c("blue","royalblue","red","darkorange"),0.4))
plot(1, xlim=c(-3,2), ylim=c(-3,0), type='n',
     xlab="Plant height (m)", ylab="Leaf mass / aboveground mass (-)",
     axes=FALSE, main="Field grown")
addlogaxes(10^-3, 10^2, 10^-3, 10^0, tck1=-0.03, tck2=-0.015)
for(i in field){
  points(log10(l[[i]]$h), log10(l[[i]]$wfrel), type='l',
         col=P$pft[i])
}
legend("bottomleft", c("Deciduous angiosperm","Deciduous gymnosperm",
                       "Evergreen angiosperm","Evergreen gymnosperm"),
       fill=alpha(palette(),0.9))
# Some flourishes for pdf in a presentation
# l_eve <- rbind.fill(l[P$pft %in% c("EA","EG")])
# l_dec <- rbind.fill(l[P$pft %in% c("DA","DG")])
# 
# library(plantecophys)
# l_eve$logwfrel <- log10(l_eve$wfrel)
# l_eve$logh <- log10(l_eve$h)
# l_dec$logwfrel <- log10(l_dec$wfrel)
# l_dec$logh <- log10(l_dec$h)
# gamplot("logh","logwfrel",dfr=l_eve,linecolor="red",add=TRUE)
# gamplot("logh","logwfrel",dfr=l_dec,linecolor="blue",add=TRUE)
# 
# dev.copy2pdf(file="analysis/output/figures/LMF_height_loglog.pdf")

palette(alpha(c("blue","royalblue","red","darkorange"),0.4))
plot(1, xlim=c(-3,2), ylim=c(-3,0), type='n',
     xlab="Plant height (m)", ylab="Leaf mass / aboveground mass (-)",
     axes=FALSE, main="Glasshouse and Common garden")
addlogaxes(10^-3, 10^2, 10^-3, 10^0, tck1=-0.03, tck2=-0.015)
for(i in nonfield){
  points(log10(l[[i]]$h), log10(l[[i]]$wfrel), type='l',
         col=P$pft[i])
}
legend("bottomleft", c("Deciduous angiosperm","Deciduous gymnosperm",
                       "Evergreen angiosperm","Evergreen gymnosperm"),
       fill=alpha(palette(),0.9))


# m.lf, m.st vs. h.t by pft.
plot(1, xlim=c(-3,2), ylim=c(-7,5), type='n',
     xlab="Plant height (m)", ylab="Leaf mass (kg)",
     axes=FALSE)
magaxis(side=1:2, unlog='xy',box=TRUE)
for(i in 1:length(l))points(log10(l[[i]]$h), log10(l[[i]]$mlf), type='l',
                            col=P$pft[i])
legend("topleft", c("Deciduous angiosperm","Deciduous gymnosperm",
                       "Evergreen angiosperm","Evergreen gymnosperm"),
       fill=palette(), inset=0.04)

plot(1, xlim=c(-3,2), ylim=c(-7,5), type='n',
     xlab="Plant height (m)", ylab="Above-ground woody mass (kg)",
     axes=FALSE)
magaxis(side=1:2, unlog='xy',box=TRUE)
for(i in 1:length(l))points(log10(l[[i]]$h), log10(l[[i]]$mst), type='l',
                            col=P$pft[i])
legend("topleft", c("Deciduous angiosperm","Deciduous gymnosperm",
                    "Evergreen angiosperm","Evergreen gymnosperm"),
       fill=palette(), inset=0.04)
@


\section{Tropical vs. temperate evergreens}

<<echo=FALSE>>=
ii <- which(P$pft == "EA" & P$vegetation %in% c("TempF","TempRF","TropRF","TropSF"))
l <- l[ii]
P <- P[ii,]

P$TempTrop <- as.factor(ifelse(P$vegetation %in% c("TempF","TempRF"), "Temp", "Trop"))
palette(c("blue","red"))


@


<<plotEA, echo=FALSE>>=


# log-log scale
plot(1, xlim=c(-3,2), ylim=c(0,1), type='n',
     xlab="Plant height (m)", ylab="Leaf mass / aboveground mass (-)",
     axes=FALSE)
addlogaxes(10^-3, 10^2, 10^-3, 10^0, tck1=-0.03, tck2=-0.015,addY=F)
axis(2)
for(i in 1:length(l)){
  points(log10(l[[i]]$h), l[[i]]$wfrel, type='l',
         col=P$TempTrop[i])
}
legend("bottomleft", c("Temperate evergreen angiosperm",
                       "Tropical evergreen angiosperm"), fill=palette())
       

plot(1, xlim=c(-3,2), ylim=c(-7,5), type='n',
     xlab="Plant height (m)", ylab="Leaf mass (kg)",
     axes=FALSE)
magaxis(side=1:2, unlog='xy',box=TRUE)
for(i in 1:length(l))points(log10(l[[i]]$h), log10(l[[i]]$mlf), type='l',
                            col=P$TempTrop[i])
legend("topleft", c("Temperate evergreen angiosperm",
                       "Tropical evergreen angiosperm"), fill=palette(),inset=0.03)

plot(1, xlim=c(-3,2), ylim=c(-7,5), type='n',
     xlab="Plant height (m)", ylab="Above-ground woody mass (kg)",
     axes=FALSE)
magaxis(side=1:2, unlog='xy',box=TRUE)
for(i in 1:length(l))points(log10(l[[i]]$h), log10(l[[i]]$mst), type='l',
                            col=P$TempTrop[i])
legend("topleft", c("Temperate evergreen angiosperm",
                       "Tropical evergreen angiosperm"), fill=palette(),inset=0.03)

@


\end{document}












