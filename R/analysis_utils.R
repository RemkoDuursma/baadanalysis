knitRnwFromHere <- function(fn){
  
  require(tools)
  newfn <- basename(fn)
  base <- file_path_sans_ext(newfn)
  exts <- c("aux","log","tex","pdf")
  on.exit(unlink(newfn))
  g <- getwd()
  f <- file.copy(fn,g)
  if(!f)stop("File copy did not succeed.")
  pdfname <- knit2pdf(newfn)   
  if(!file.exists("output/pdf"))dir.create("output/pdf")
  file.copy(pdfname, "output/pdf", overwrite=TRUE)
  unlink(paste0(base,".",exts))
  unlink("figure", recursive=TRUE)
}


knitRmdFromHere <- function(fn){
  
  require(tools)
  g <- getwd()
  f <- file.copy(fn,g)
  newfn <- basename(fn)
  on.exit(unlink(newfn))
  if(!f)stop("File copy did not succeed.")
  #htmlname <- knit2html(newfn)  
  htmlname <- render(newfn, envir=new.env())
  if(!file.exists("output/html"))dir.create("output/html")
  file.copy(htmlname, "output/html", overwrite=TRUE)
  base <- file_path_sans_ext(newfn)
  
  exts <- c("md","html")
  unlink(paste0(base,".",exts))
  unlink("figure", recursive=TRUE)
}

removeNAcols <- function(dfr){
  
  dfr[,sapply(dfr, function(x)!all(is.na(x)))]
  
} 


studyWithVars <- function(allom, hasVars, groupname="studyName",
                          returnwhat=c("dataframe","list"),  
                          complete.cases=FALSE){
  
  r <- require(plyr)
  if(!r)stop("Install plyr package first.")
  returnwhat <- match.arg(returnwhat)
  l <- split(allom, allom[[groupname]])
  l <- lapply(l, removeNAcols)
  ihasvars <- sapply(l, function(x) all(hasVars %in% names(x)))
    
  if(sum(ihasvars) == 0){
    message("No datasets have values in all those columns.")
    return(NA)
  } else {
    message("Your query returned ",sum(ihasvars)," studies with n=",sum(sapply(l[ihasvars],nrow))," observations.")
    if(returnwhat=="list"){
      if(complete.cases)warning("complete.cases=TRUE ignored when list is returned.")
      return(l[ihasvars])
    }else{
      dfr <- rbind.fill(l[ihasvars])
      if(complete.cases){
        dfr <- dfr[complete.cases(dfr[,hasVars]),]
      }
      return(dfr)
    }
  }
  
}




addlogaxes <- function(Xfrom=1, Xto=1000, Yfrom=0.01, Yto=100, addX=T, addY=T,
                       tck1=-0.05, tck2=-0.01, labeltype=1){
  
  p <- log10(Xfrom):log10(Xto)
  z <- log10(Yfrom):log10(Yto)
  
  if(labeltype == 1){
    Labels <- lapply(p, function(x)substitute(expression(10^p), list(p=x)))
    Labels <- do.call("c", Labels)
  }
  if(labeltype == 2)Labels <- 10^p
  
  # Major ticks at X-axis
  if(addX)axis(1, at=p,labels=Labels, tck=tck1)
  
  # Minor ticks X-axis
  ps <- c()
  for(i in 1:(length(p)-1))ps <- c(ps, seq(10^p[i],10^p[i+1],length=10))
  if(addX)axis(1,log10(ps),labels=F,tck=tck2)
  
  # Major ticks at Y-axis
  
  if(labeltype == 1){
    Labels <- lapply(z, function(x)substitute(expression(10^z), list(z=x)))
    Labels <- do.call("c", Labels)
  }
  if(labeltype == 2)Labels <- 10^z
  
  if(addY)axis(2, at=z,labels=Labels, tck=tck1)
  
  # Minor ticks Y-axis
  zs <- c()
  for(i in 1:(length(z)-1))zs <- c(zs, seq(10^z[i],10^z[i+1],length=10))
  if(addY)axis(2,log10(zs),labels=F,tck=tck2)
  box()
}




#grabbed from stackoverflow:
#http://stackoverflow.com/questions/3369959/moving-columns-within-a-data-frame-without-retyping

#'@examples
#'\dontrun{
#'
#'moveme(names(df), "g first")
# moveme(names(df), "g first; a last; e before c")
# Of course, using it to reorder the columns in your data.frame is straightforward:
#   
#   df[moveme(names(df), "g first")]
# And for data.tables (moves by reference, no copy) :
#   
#   setcolorder(dt, moveme(names(dt), "g first"))
#'}
moveme <- function (invec, movecommand) {
  movecommand <- lapply(strsplit(strsplit(movecommand, ";")[[1]], 
                                 ",|\\s+"), function(x) x[x != ""])
  movelist <- lapply(movecommand, function(x) {
    Where <- x[which(x %in% c("before", "after", "first", 
                              "last")):length(x)]
    ToMove <- setdiff(x, Where)
    list(ToMove, Where)
  })
  myVec <- invec
  for (i in seq_along(movelist)) {
    temp <- setdiff(myVec, movelist[[i]][[1]])
    A <- movelist[[i]][[2]][1]
    if (A %in% c("before", "after")) {
      ba <- movelist[[i]][[2]][2]
      if (A == "before") {
        after <- match(ba, temp) - 1
      }
      else if (A == "after") {
        after <- match(ba, temp)
      }
    }
    else if (A == "first") {
      after <- 0
    }
    else if (A == "last") {
      after <- length(myVec)
    }
    myVec <- append(temp, values = movelist[[i]][[1]], after = after)
  }
  myVec
}





getWorldClim <- function(longitude, latitude, varname, worldclim_dataloc = "c:/data/worldclim"){
  
  
  
  here <- data.frame(lon=longitude,lat=latitude)
  coordinates(here) <- c("lon", "lat")
  proj4string(here) <- CRS("+proj=longlat +datum=WGS84")
  
  coors <- SpatialPoints(here)
  
  extractVar <- function(varname, where, ind=1:12){
    p <- list()
    
    dir <- paste0(worldclim_dataloc,"/",varname,"/")
    
    vars <- paste0(varname,"_", ind)
    
    for (i in 1:length(vars)){
      a <- raster(paste0(dir,vars[i]))
      dataVal <- extract(a,where)
      p[[i]] <- dataVal
    }
    outvars <- do.call(cbind,p)
    names(outvars) <- vars
    return(outvars)
  }
  
  tmeans <- extractVar(varname, coors)
  
  return(matrix(tmeans, ncol=12))
}
