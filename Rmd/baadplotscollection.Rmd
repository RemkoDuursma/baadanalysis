---
title: "Collection of BAAD plots"
output: html_document
---

```{r echo=FALSE}

source("load.R")

```

Goals
1. Find systematic differences that need to be accounted for in models.
2. Previous focus on universal patterns, but have not been able to look at pft / biome effects.
3. How much of variance due to species, biome, pft?
4. Functional balance : plots of root mass vs. leaf area or leaf mass
5. Root-shoot ratios : aboveground biomass vs. root mass.



### Pipe-model relationships

This figure shows average calculated pipe-model relationships, either at breast height (using `a.stbh`) or base (`a.stba`). Pipe-model ratios are calculated by dataset/species combinations, error bars are 1 S.E., sample sizes above bars are number of dataset/species combinations.

Deciduous gymnosperm (*Larix*) was removed for clarity (only two datasets with a single species, and only breast height).

In the plots, A<sub>L</sub> is leaf area, A<sub>W</sub> is stem cross-sectional area, M<sub>F</sub> is leaf mass.


```{r echo=FALSE,message=FALSE}

# BH pipemodel relationships
datl <- studyWithVars(baad, c("a.stbh", "a.lf","m.lf"), returnwhat="list")
dat <- rbind_all(datl)

# Roth2007 massive outlier, remove here
dat <- subset(dat, dataset != "Roth2007")

# remove DG; there is only one species which makes it confusing
dat <- subset(dat, pft != "DG")



pipe_bh <- summarize(group_by(dat, dataset, species), 
           alf_stbh=mean(a.lf / a.stbh),
           mlf_stbh=mean(m.lf / a.stbh),
           sla = mean(a.lf / m.lf),
           pft=first(pft),
           MAP=mean(MAP),
           MAT=mean(MAT),
           growingCondition=first(growingCondition),
           vegetation=first(vegetation))
           
# Basal pipemodel relationships
datl <- studyWithVars(baad, c("a.stba", "a.lf","m.lf"), returnwhat="list")

dat$pft <- as.factor(dat$pft)
pipe_bh$pft <- as.factor(pipe_bh$pft)

pipe_ba <- summarize(group_by(dat, dataset, species), 
                     alf_stba=mean(a.lf / a.stba),
                     mlf_stba=mean(m.lf / a.stba),
                     pft=first(pft),
                     MAP=mean(MAP),
                     MAT=mean(MAT),
                     growingCondition=first(growingCondition),
                     vegetation=first(vegetation))



BARplot <- function(x,y,ymult=1.2,...){
  
  N <- table(x)
  tap <- tapply(y,x,mean,na.rm=T)
  Ylim <- c(0, max(tap)*ymult)
  b <- bargraph.CI(x,y,ylim=Ylim,err.width=0.04,...)
  
  d <- 0.3
  text(c(0.3, b$xvals+d), max(tap)*(1.1/1.2)*ymult, labels=c("N =", as.character(unname(N))))
  
  return(invisible(b))
}

Cols <- c("blue","red","darkorange")
palette(Cols)
# Cols <- c("blue","royalblue","red","darkorange")

par(mfrow=c(2,2), mar=c(5,5,2,2))
with(pipe_bh, BARplot(pft,alf_stbh, xlab="Plant functional type", 
                       ylab=expression(A[L]/A[W]~breast~height~~(m^2~m^-2)),
                       col=Cols))
with(pipe_bh, BARplot(pft,mlf_stbh, xlab="Plant functional type",
                       ylab=expression(M[F]/A[W]~breast~height~~(kg~m^-2)),
                       col=Cols
                       ))
with(pipe_ba, BARplot(pft,alf_stba, xlab="Plant functional type", 
                          ylab=expression(A[L]/A[W]~base~~(m^2~m^-2)),
                          col=Cols))
b <- with(pipe_ba, BARplot(pft,mlf_stba, xlab="Plant functional type",
                          ylab=expression(M[F]/A[W]~base~~(kg~m^-2)),
                          col=Cols,ymult=1.3
))



with(pipe_bh, plot(sla, alf_stbh, pch=19, col=pft, xlim=c(0,50),
                   xlab=expression(Specific~leaf~area~~(m^2~kg^-1)),
                   ylab=expression(A[L]/A[W]~breast~height~~(m^2~m^-2))))
legend("topright", levels(pipe_bh$pft), col=palette(), pch=19)


with(pipe_bh, plot(sla, mlf_stbh, pch=19, col=pft, xlim=c(0,50),
                   xlab=expression(Specific~leaf~area~~(m^2~kg^-1)),
                   ylab=expression(M[F]/A[W]~breast~height~~(m^2~m^-2))))
legend("topright", levels(pipe_bh$pft), col=palette(), pch=19)


```








### Allometry relationships by dataset and pft


The following figures use a subset of data, including only field-grown plants, and only species/dataset combinations that have at least 20 observations. Lines are `sma` fits. 


```{r echo=FALSE}

# baad2 : discard pot-grown plants
baad$Group <- paste(baad$dataset, baad$speciesMatched)
baad2 <- subset(baad, growingCondition %in% c("FW","PM","PU","FE"))
baad2$pft <- as.factor(baad2$pft)

# estimate basal diameter from dbh and h.t
dba <- with(baad2, d.bh * h.t / (h.t - 1.3))
dba[!is.finite(dba)] <- NA
dba[!(baad2$h.bh %in% c(1.3,1.37))] <- NA 
dba[baad2$h.t < 1.5] <- NA
baad2$d.ba[is.na(baad2$d.ba)] <- dba[is.na(baad2$d.ba)]


allombygroupandpftplot <- function(xvar, yvar, dataset, xlab=AxisLabels[[xvar]], ylab=AxisLabels[[yvar]], 
                                   slopecomp=1, n_min=20,legend=FALSE,
                                   pftcols=list(EA="red", EG="hotpink", DA="blue")){

  dataset$X <- dataset[,xvar]
  dataset$Y <- dataset[,yvar]
  
  smfitsEA <- sma(Y ~ X*Group, data=subset(dataset,pft=="EA"), log='xy', n_min=n_min, quiet=TRUE)
  smfitsEG <- sma(Y ~ X*Group, data=subset(dataset,pft=="EG"), log='xy', n_min=n_min, quiet=TRUE)
  smfitsDA <- sma(Y ~ X*Group, data=subset(dataset,pft=="DA"), log='xy', n_min=n_min, quiet=TRUE)
  smfits <- sma(Y ~ X*Group, data=dataset, log='xy', n_min=n_min, quiet=TRUE)
  
  plot(smfits, col="black", type='n', axes=FALSE,
       xlab=xlab,
       ylab=ylab,
       panel.first={
         for(z in -15:15)abline(z,slopecomp,col="grey")
       })
  magaxis(side=1:2, unlog=1:2)
  plot(smfitsEA, add=TRUE, type='l', col=pftcols$EA)
  plot(smfitsEG, add=TRUE, type='l', col=pftcols$EG)
  plot(smfitsDA, add=TRUE, type='l', col=pftcols$DA)
  
  if(legend)legend("topleft", c("Evergreen Angio.","Evergreen Gymno", "Deciduous Angio."), 
                   fill=unlist(pftcols), cex=0.9)  
return(invisible(smfits))
}



AxisLabels <- list(m.to = "Total plant mass (kg)",
                   m.so = "Above-ground plant mass (kg)",
                   m.lf = "Total leaf mass (kg)",
                   m.rt = "Total root mass (kg)",
                   m.rf = "Fine root mass (kg)",
                   d.bh = "Diameter at breast height (m)",
                   d.ba = "Diameter at base (m)",
                   a.stbh = expression("Stem area at breast height"~~(m^2)),
                   a.stba = expression("Stem area at base"~~(m^2)),
                   a.lf = expression("Total leaf area"~~(m^2)),
                   h.t = "Total plant height (m)",
                   h.c = "Height to crown base (m)",
                   c.d = "Crown length (m)",
                   d.cr = "Crown diameter (m)")
              

```



```{r echo=FALSE, warning=FALSE}
              
par(cex.lab=1.2, mar=c(5,5,2,2))
allombygroupandpftplot("m.to", "m.lf", baad2, legend=T)
allombygroupandpftplot("m.to", "a.lf", baad2)

allombygroupandpftplot("m.so", "m.lf", baad2)
allombygroupandpftplot("m.so", "a.lf", baad2)

allombygroupandpftplot("a.stbh", "m.lf", baad2)
allombygroupandpftplot("a.stba", "m.lf", baad2)

allombygroupandpftplot("h.t", "m.so", baad2, slopecomp=2, legend=T)

allombygroupandpftplot("h.t", "m.lf", baad2, slopecomp=2, legend=T)
allombygroupandpftplot("h.t", "a.lf", baad2, slopecomp=2, legend=T)

allombygroupandpftplot("d.bh", "m.so", baad2, slopecomp=2, legend=T)
allombygroupandpftplot("d.ba", "m.so", baad2, slopecomp=2, legend=T)

allombygroupandpftplot("m.so", "m.rt", baad2, legend=T)
allombygroupandpftplot("m.lf", "m.rf", baad2, legend=T)

allombygroupandpftplot("c.d", "m.lf", baad2, legend=T)
allombygroupandpftplot("c.d", "d.cr", baad2, legend=T)

```



### Leaf mass ratio (LMR) by plant functional type

The following uses only dataset/species combinations that have at least 20 observations. Using `sma`, I fit leaf mass vs. plant height, and stem mass vs. plant height. From the coefficients of the fits we can calculate the size-dependent LMR relationship, which is not a log-log relationship (math will follow here).

We conclude that

1. Evergreens have much higher LMR at a given plant height than deciduous plants, but angiosperm/gymnosperm does not seem to matter (analysis will follow)
2. Field grown plants show similar relationships, a declining LMR with increasing plant height. Sheltered (glasshouse or common garden) plants show a wide range of relationships. 



```{r echo=FALSE, message=FALSE}

# Select datasets that have stem, leaf biomass, and height
x <- studyWithVars(baad, c("m.st","m.lf","h.t"))
x$dataset_species <- paste0(x$dataset,"_",x$species)

# clean
x <- subset(x, m.lf > 0 & m.st > 0 & !is.na(m.lf) & !is.na(m.st) & !is.na(h.t))

# Keep only dataset_species with at least 20 observations
tab <- table(x$dataset_species)
x <- x[x$dataset_species %in% names(tab)[tab>19],]


sm_mlf <- sma(m.lf ~ h.t * dataset_species, log="xy", data=x)
sm_mst <- sma(m.st ~ h.t * dataset_species, log="xy", data=x)

# sma coefficients
makedfr <- function(z){
  z$dataset_species <- rownames(z)
  as.data.frame(z)
}
p_mlf <- coef(sm_mlf)
names(p_mlf) <- c("b0_mlf","b1_mlf")
p_mst <- coef(sm_mst)
names(p_mst) <- c("b0_mst","b1_mst")
p <- merge(makedfr(p_mlf),makedfr(p_mst))

# Find ranges for h.t
r <- t(sapply(p$dataset_species, function(lev){
    range(x$h.t[x$dataset_species==lev], na.rm=TRUE)
}))
colnames(r) <- c("ht_min","ht_max")

# P is a dataframe with leaf, stem scaling, and ranges of h.t
P <- cbind(p,r)
rownames(P) <- NULL

# Add some metadata
dfr <- baad[,c("dataset","species","pft","vegetation","growingCondition")]
dfr$dataset_species <- with(dfr, paste0(dataset,"_",species))
dfr <- dfr[!duplicated(dfr$dataset_species),]
P <- merge(P, dfr)
P$pft <- as.factor(P$pft)
P$vegetation[is.na(P$vegetation)] <- "GH"
P$vegetation <- as.factor(P$vegetation)


# Plot : save predictions in a list
l <- lapply(1:nrow(P), function(i){
  h <- seq(P$ht_min[i], P$ht_max[i], length=101)
  a <- 10^(P$b0_mlf[i])
  b <- P$b1_mlf[i]
  c <- 10^(P$b0_mst[i])
  d <- P$b1_mst[i]
  wfrel <- a*h^b/(a*h^b + c*h^d)
  mst <- c*h^d
  mlf <- a*h^b
  return(data.frame(h=h,wfrel=wfrel,mlf=mlf,mst=mst))
})

# nonfield <- union(which(P$vegetation == "GH"), which(P$dataset == "Poorter1999"))
nonfield <- which(P$growingCondition %in% c("CG","GH"))
field <- setdiff(1:nrow(P), nonfield)

# Non-glasshouse
palette(alpha(c("blue","royalblue","red","darkorange"),0.4))
plot(1, xlim=c(-3,2), ylim=c(-3,0), type='n',
     xlab="Plant height (m)", ylab="Leaf mass / aboveground mass (-)",
     axes=FALSE, main="Field grown")
addlogaxes(10^-3, 10^2, 10^-3, 10^0, tck1=-0.03, tck2=-0.015)
for(i in field){
  points(log10(l[[i]]$h), log10(l[[i]]$wfrel), type='l',
         col=P$pft[i])
}
legend("bottomleft", c("Deciduous angiosperm","Deciduous gymnosperm",
                       "Evergreen angiosperm","Evergreen gymnosperm"),
       fill=alpha(palette(),0.9))
# Some flourishes for pdf in a presentation
# l_eve <- rbind.fill(l[P$pft %in% c("EA","EG")])
# l_dec <- rbind.fill(l[P$pft %in% c("DA","DG")])
# 
# library(plantecophys)
# l_eve$logwfrel <- log10(l_eve$wfrel)
# l_eve$logh <- log10(l_eve$h)
# l_dec$logwfrel <- log10(l_dec$wfrel)
# l_dec$logh <- log10(l_dec$h)
# gamplot("logh","logwfrel",dfr=l_eve,linecolor="red",add=TRUE)
# gamplot("logh","logwfrel",dfr=l_dec,linecolor="blue",add=TRUE)
# 
# dev.copy2pdf(file="analysis/output/figures/LMF_height_loglog.pdf")

palette(alpha(c("blue","royalblue","red","darkorange"),0.4))
plot(1, xlim=c(-3,2), ylim=c(-3,0), type='n',
     xlab="Plant height (m)", ylab="Leaf mass / aboveground mass (-)",
     axes=FALSE, main="Glasshouse and Common garden")
addlogaxes(10^-3, 10^2, 10^-3, 10^0, tck1=-0.03, tck2=-0.015)
for(i in nonfield){
  points(log10(l[[i]]$h), log10(l[[i]]$wfrel), type='l',
         col=P$pft[i])
}
legend("bottomleft", c("Deciduous angiosperm","Deciduous gymnosperm",
                       "Evergreen angiosperm","Evergreen gymnosperm"),
       fill=alpha(palette(),0.9))
```


### MAT and MAP

Comparison between user-supplied and estimates from WorldClim of mean annual temperature (MAT) and mean annual precipitation (MAP). 


```{r echo=FALSE}
par(cex.axis=0.7, xaxs="i", yaxs="i")
dat <- baad[!duplicated(paste(baad$latitude, baad$longitude)),]
  
par(mfrow=c(1,2))
with(dat, plot(MAP, map, xlab="MAP - WorldClim (mm)", ylab="MAP - User supplied (mm)", 
               pch=19, col=make.transparent("blue"),
               xlim=c(0,5200), ylim=c(0,5200)))
abline(0,1)
with(dat, plot(MAT, mat, xlab=expression("MAT - WorldClim"~(degree*C)), 
               ylab=expression("MAT - User supplied"~(degree*C)),
               xlim=c(0,32), ylim=c(0,32),
               pch=19, col=make.transparent("red")))
abline(0,1)
```    
   
   
### Pipe model fits



```{r warning=FALSE, message=FALSE, echo=FALSE}
getAttributeByStudy <- function(data, var, studies){
  i <- !is.na(data[[var]])
  data[c("dataset", var)][!duplicated(paste( data[["dataset"]], data[[var]])),]
}

addIsoclines <- function(A= seq(-10,10),...){
  for(a in A) abline(a,1,lty="dotted",...)
}

myplot <- function(data, xvar,yvar,g,add=FALSE,col=niceColors(1),add11=TRUE,...){
  bivarPlotColorBy(data, xvar, yvar,g,col=make.transparent("grey", 0.4), 
                   pch=16,type='p',add=add,...)
  bivarPlotColorBy(data, xvar, yvar,group=g,col=col,lwd=1, type='l', add=TRUE)
}


myfigure <- function(data){
  
  #par(mfrow=c(2,4), oma = c(4,4,4,4))
  var <- "species"
  xlim <- c(10^-7, 1)
  ylim <- c(10^-5, 10^3)
  cols <- niceColors(3)
  
  f <- list()
  f[[1]] <- myplot(data,"a.stba", "a.lf", var,col=cols[1],xlim=xlim, 
                   ylim=ylim, main = "base")
  addIsoclines()
  f[[2]] <- myplot(data,"a.stbh", "a.lf", var,col=cols[2], xlim=xlim, 
                   ylim=ylim, main = "breast")
  addIsoclines()
  f[[3]] <- myplot(data,"a.stbc", "a.lf", var,col=cols[3],xlim=xlim, 
                   ylim=ylim, main = "crown base")
  addIsoclines()
  
  bivarPlotColorBy(data, "a.stba", "a.lf", var,type='l', col=cols[1], xlim=xlim, ylim=ylim, main = "all")
  bivarPlotColorBy(data, "a.stbh", "a.lf", var, type='l', col=cols[2], add=TRUE)
  bivarPlotColorBy(data, "a.stbc", "a.lf", var, type='l', col=cols[3], add=TRUE)
  addIsoclines()
  mtext("Total stem", side=4)
  
  f <- list()
  f[[1]] <- myplot(data,"a.ssba", "a.lf", var,col=cols[1],
                   xlim=xlim, ylim=ylim, main = "base")
  addIsoclines()
  f[[2]] <- myplot(data,"a.ssbh", "a.lf", var,col=cols[2],
                   xlim=xlim, ylim=ylim, main = "breast")
  addIsoclines()
  f[[3]] <- myplot(data,"a.ssbc", "a.lf", var,col=cols[3],
                   xlim=xlim, ylim=ylim, main = "crown base")
  addIsoclines()
  
  bivarPlotColorBy(data, "a.ssba", "a.lf", var, type='l', col=cols[1], xlim=xlim, ylim=ylim, main = "all")
  bivarPlotColorBy(data, "a.ssbh", "a.lf", var, type='l', col=cols[2], add=TRUE)
  bivarPlotColorBy(data, "a.ssbc", "a.lf", var, type='l', col=cols[3], add=TRUE)
  addIsoclines()
  mtext("Sapwood", side=4)
}
myfigure(baad)
```

   
