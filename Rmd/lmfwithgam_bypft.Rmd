---
title: "LMR with gam"
author: "Remko Duursma"
date: "Friday, September 05, 2014"
output: html_document
---
  
  
```{r init, echo=FALSE}
library(knitr)
opts_knit$set(root.dir=normalizePath('../'))
opts_chunk$set(echo=FALSE, warning=FALSE, error=FALSE, message=FALSE)
```


```{r load}

library(mgcv)
library(plantecophys)
library(reshape2)

source("load.R")
source("R/prepareDataset.R")
```


```{r functions}
source("R/gam_functions.R")
```


### Leaf mass fraction and leaf area ratio by pft

#### LMF
```{r lmfpft}
gamplotandpred(dataset2, "pft", "lmlf_mso")
```

#### LAR
```{r larpft}
gamplotandpred(dataset2, "pft", "lalf_mso")
```

### Pipe model ratios by pft

#### Leaf mass pipe ratio
```{r pipemlfpft}
pipemlf <- gamplotandpred(dataset2, "pft", "lmlf_astbh", Hs=c(3,10))
```

#### Leaf area pipe ratio
```{r pipealfpft}
pipealf <- gamplotandpred(dataset2, "pft", "lalf_astbh", Hs=c(3,10))
```



```{r}
sla <- gamplotandpred(dataset2, "pft", "lsla", Hs=c(3,10))
```





```{r eval=FALSE}

dat <- subset(dataset2,!is.na(a.stbh) & !is.na(m.so))
datsp <- split(dat, dat$Group)
ii <- which(sapply(datsp,nrow) > 10)
lms <- lapply(datsp[ii],
              function(x)lm(log10(m.so) ~ log10(a.stbh), data=x))  
getr2 <- function(x)summary(x)$adj.r.squared

r2 <- sapply(lms, getr2)


```


```{r eval=FALSE}
lme1 <- lme(log10(m.so) ~ log10(a.stbh), random=~log10(a.stbh)|Group, 
            data=dataset2, subset=pft=="EG", na.action=na.omit)
lme2 <- lme(log10(m.so) ~ log10(a.stbh), random=~log10(a.stbh)|Group, 
            data=dataset2, subset=pft=="EA", na.action=na.omit)
lme3 <- lme(log10(m.so) ~ log10(a.stbh), random=~log10(a.stbh)|Group, 
            data=dataset2, subset=pft=="DA", na.action=na.omit)

datsp <- split(dataset2, dataset2$Group)
R <- sapply(datsp, function(x)range(x$a.stbh))

makedf <- function(x){
  
  p <- coef(x)
  g <- rownames(p)
  r <- R[,g]
  df <- as.data.frame(cbind(p,t(r)))
  names(df) <- c("a","b","xmin","xmax")
  
  return(df)
}

p <- makedf(lme1)
pointsp <- function(x,...){
  for(i in 1:nrow(x)){
    ablinepiece(x$a[i], x$b[i], from=log10(x$xmin[i]), to=log10(x$xmax[i]), ...)
  }
}
with(dataset2, plot(log10(a.stbh), log10(m.so), type='n'))
pointsp(makedf(lme1), col="red")
pointsp(makedf(lme2), col="green3")
pointsp(makedf(lme3), col="blue")


```




